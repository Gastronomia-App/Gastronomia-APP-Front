<div class="aside-panel-wrapper">
  <header class="aside-panel-header">
    <h2>{{ order().seatingNumber ? 'MESA ' + order().seatingNumber : 'Orden' }}</h2>
    <div class="header-actions">
      <button type="button" class="btn-icon" (click)="onPrintBill()" title="Imprimir cuenta">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
          <polyline points="14 2 14 8 20 8" />
          <line x1="16" y1="13" x2="8" y2="13" />
          <line x1="16" y1="17" x2="8" y2="17" />
          <polyline points="10 9 9 9 8 9" />
        </svg>
      </button>
      <button type="button" class="btn-icon" (click)="onSplitOrder()" title="Dividir orden">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="3" width="18" height="18" rx="2" />
          <line x1="2" y1="2" x2="22" y2="22" />
        </svg>
      </button>
      <button class="btn-icon" (click)="editRequested.emit()">
        <svg width="20" height="20" viewBox="0 0 24 24">
          <path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 
         7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a1 1 0 0 
         0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" />
        </svg>
      </button>
      <button type="button" class="btn-close" (click)="onClose()">✕</button>
    </div>
  </header>

  <div class="aside-panel-container">
    <!-- Info de la orden -->
    <div class="order-info-grid">
      <div class="info-item">
        <span class="info-label">Personas:</span>
        <span class="info-value">{{ order().peopleCount || 0 }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Cliente:</span>
        <span class="info-value">{{ order().customerName || 'Sin asignar' }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Camarero:</span>
        <span class="info-value">{{ order().employeeName || 'N/A' }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Fecha:</span>
        <span class="info-value">{{ order().dateTime ? (order().dateTime | date:'yyyy-MM-dd HH:mm') : 'N/A' }}</span>
      </div>
    </div>

    <!-- Sección de adicionar productos -->
    <section class="add-section">
      <h3 class="section-title">ADICIONAR</h3>

      <app-searchable-list placeholder="Buscar producto..." [availableItems]="availableProducts()"
        [selectedItems]="pendingItems()" [isLoading]="isLoadingProducts()" [allowQuantitySelection]="true"
        [allowDuplicates]="true" (searchFocus)="onSearchFocus()" (itemAdded)="onProductAdded($event)">
      </app-searchable-list>

      <!-- Items pendientes a confirmar -->
      @if (pendingItems().length > 0) {
      <div class="pending-items">
        @for (item of pendingItems(); track item.id) {
        <div class="pending-item-container">
          <app-item-card [item]="item" [customFields]="[
                { key: 'quantity', label: 'Cantidad', type: 'number', editable: true }
              ]" [editableFields]="true" [showRemoveButton]="true" (itemUpdated)="onUpdatePendingItem($event)"
            (itemRemoved)="onRemovePendingItem($event)">
          </app-item-card>
          
          <!-- Selección de opciones de producto grupos (SELECTABLE/FIXED_SELECTABLE) -->
          @if (hasSelectableGroups(item)) {
          <div class="product-options-section">
            <h4 class="options-title">Seleccionar opciones:</h4>
            @for (group of getProductGroups(item); track group.id) {
            <div class="product-group">
              <label class="group-label">
                {{ group.name }}
                @if (group.minQuantity > 0) {
                <span class="required-indicator">*</span>
                }
              </label>
              <select 
                class="group-select"
                [value]="getSelectedOptionForGroup(item.id, group)"
                (change)="onProductOptionChange(item.id, group, getProductOptionById(group, +$any($event.target).value)!)">
                <option value="0">-- Seleccionar --</option>
                @for (option of group.options; track option.id) {
                <option [value]="option.id">
                  {{ option.productName }}
                  @if (option.priceIncrease > 0) {
                  (+${{ option.priceIncrease }})
                  }
                </option>
                }
              </select>
            </div>
            }
          </div>
          }
        </div>
        }
      </div>

      <!-- Botones de acción para items pendientes -->
      <div class="pending-actions">
        <button type="button" class="secondary" (click)="cancelPendingItems()">
          Cancelar
        </button>
        <button type="button" class="btn-primary" (click)="confirmPendingItems()">
          Confirmar
        </button>
      </div>
      }
    </section>

    <!-- Lista de items confirmados -->
    <section class="confirmed-items-section">
      <h3 class="section-title">
        Items confirmados ({{ activeConfirmedItems().length }})
      </h3>

      @if (activeConfirmedItems().length === 0) {
      <p class="empty-message">No hay items en esta orden</p>
      } @else {
      <div class="confirmed-items-list">
        @for (item of confirmedItemsWithName(); track item.id) {
        <div class="confirmed-item-container">
          <app-item-card [item]="item" [customFields]="[
                { key: 'quantity', label: 'Cantidad', type: 'number' },
                { key: 'totalPrice', label: 'Total', type: 'currency', suffix: '$' }
              ]" [editableFields]="false" [showRemoveButton]="true" (itemUpdated)="onUpdateConfirmedItem($event)"
            (itemRemoved)="onRemoveConfirmedItem($event)">
          </app-item-card>
          
          <!-- Display selected product options -->
          @if (item.selectedOptions && item.selectedOptions.length > 0) {
          <div class="selected-options-display">
            <span class="options-label">Opciones:</span>
            <div class="options-list">
              @for (option of item.selectedOptions; track option.id) {
              <span class="option-item">
                {{ option.productOption.productName }}
                @if (option.quantity > 1) {
                (x{{ option.quantity }})
                }
                @if (option.productOption.priceIncrease > 0) {
                (+${{ option.productOption.priceIncrease }})
                }
              </span>
              }
            </div>
          </div>
          }
        </div>
        }
      </div>
      }
    </section>

    <!-- Sección de totales -->
    <section class="totals-section">
      <div class="total-row">
        <span class="total-label">Subtotal:</span>
        <span class="total-value">${{ subtotal().toFixed(2) }}</span>
      </div>

      <div class="discount-row">
        <label class="discount-label">
          Descuento (%):
          <input type="number" class="discount-input" [ngModel]="discount()" (ngModelChange)="discount.set($event)"
            (blur)="onDiscountChange()" min="0" max="100" />
        </label>
        @if (discount() > 0) {
        <span class="discount-amount">-${{ discountAmount().toFixed(2) }}</span>
        }
      </div>

      <div class="total-row total-row-main">
        <span class="total-label-main">Total:</span>
        <span class="total-value-main">${{ total().toFixed(2) }}</span>
      </div>
    </section>
  </div>

  <!-- Footer con botones de acción -->
  <footer class="aside-panel-footer">
    <button type="button" class="secondary" (click)="onClose()">
      Cancelar
    </button>
    <button type="button" class="btn-primary" (click)="onFinalizeOrder()">
      Finalizar orden
    </button>
  </footer>
</div>

<app-confirmation-modal [isVisible]="showDeleteConfirmation()" [title]="'Eliminar item'"
  [message]="'¿Estás seguro de eliminar este item de la orden?'" [confirmText]="'Eliminar'" [cancelText]="'Cancelar'"
  [isDanger]="true" (confirm)="confirmDeleteItem()" (cancel)="cancelDeleteItem()">
</app-confirmation-modal>

@if (showSplitForm()) {
<app-order-split-form [order]="currentOrder()!" (splitCompleted)="onSplitCompleted()"
  (splitCanceled)="onSplitFormClosed()">
</app-order-split-form>
}