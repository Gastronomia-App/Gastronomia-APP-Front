<div class="modal-backdrop" (click)="cancel()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>
        {{ product().name }}
        @if (currentContext().type === 'option') {
          <span class="context-indicator"> › Configurando Sub-Opciones</span>
        }
      </h2>
      <button type="button" class="btn-close" (click)="cancel()">✕</button>
    </div>

    <div class="modal-body">
      <div class="options-layout">
        <div class="options-column">
          <div class="tabs-navigation">
            @for (group of currentProductGroups(); track group.id; let i = $index) {
              <button 
                type="button"
                class="tab-btn"
                [class.active]="activeTabIndex() === i"
                (click)="switchTab(i)">
                {{ group.name }}
                @if (groupSummaries()[i]) {
                  <span class="tab-counter">{{ groupSummaries()[i].current }}/{{ groupSummaries()[i].max }}</span>
                }
              </button>
            }
          </div>

          @if (activeGroup(); as group) {
            <div class="options-grid">
              @for (option of group.options; track option.id) {
                <button 
                  type="button"
                  class="option-btn"
                  [class.selected]="getOptionCount(option) > 0"
                  [disabled]="isOptionDisabled(option)"
                  (click)="selectOption(option)">
                  <span class="option-name">{{ option.productName }}</span>
                  @if (option.priceIncrease && option.priceIncrease > 0) {
                    <span class="option-price">+${{ option.priceIncrease.toFixed(2) }}</span>
                  }
                  @if (getOptionCount(option) > 0) {
                    <span class="option-badge">{{ getOptionCount(option) }}</span>
                  }
                </button>
              }
            </div>
          }
        </div>

        <div class="summary-column">
          <div class="summary-header">
            <h4>Resumen Grupos</h4>
            <div class="summary-list">
              @for (summary of groupSummaries(); track summary.groupName) {
                <div class="summary-item" [class.invalid]="!summary.isValid">
                  <span class="summary-name">
                    {{ summary.groupName }}
                    @if (!summary.isValid) {
                      <span class="required-indicator">*</span>
                    }
                  </span>
                  <span class="summary-count">{{ summary.current }}/{{ summary.max }}</span>
                </div>
              }
            </div>
          </div>

          <div class="selected-items">
            <h4>Items y Opciones</h4>
            <div class="items-list">
              @for (item of items(); track item.index) {
                @let isSelected = currentContext().itemIndex === item.index && currentContext().type === 'item';
                @let itemKey = 'item-' + item.index;
                @let expanded = isExpanded(itemKey);
                
                <app-selectable-item-card
                  [name]="item.productName + ' #' + (item.index + 1)"
                  [quantity]="1"
                  [isSelected]="isSelected"
                  [hasChildren]="item.selections.length > 0"
                  [isExpanded]="expanded"
                  (clicked)="onItemClick(item.index)"
                  (remove)="onRemoveItem(item.index)"
                  (toggleExpand)="toggleItemExpansion(itemKey)">
                </app-selectable-item-card>

                @if (expanded && item.selections.length > 0) {
                  @for (selection of item.selections; track selection.productOption.id; let selIdx = $index) {
                    @let selKey = itemKey + '-sel-' + selIdx;
                    @let selExpanded = isExpanded(selKey);
                    @let optionPath = [selIdx];
                    @let isSelSelected = currentContext().itemIndex === item.index && 
                                          currentContext().type === 'option' && 
                                          pathEquals(currentContext().optionPath, optionPath);
                    
                    <app-selectable-item-card
                      [name]="selection.productOption.productName"
                      [quantity]="selection.quantity"
                      [price]="selection.productOption.priceIncrease"
                      [isSelected]="isSelSelected"
                      [hasChildren]="(selection.selectedOptions?.length || 0) > 0"
                      [isExpanded]="selExpanded"
                      [indentLevel]="1"
                      (clicked)="onOptionClick(item.index, optionPath)"
                      (remove)="onRemoveOption(item.index, optionPath)"
                      (toggleExpand)="toggleItemExpansion(selKey)">
                    </app-selectable-item-card>

                    @if (selExpanded && selection.selectedOptions && selection.selectedOptions.length > 0) {
                      @for (subOption of selection.selectedOptions; track subOption.productOption.id; let subIdx = $index) {
                        @let subPath = [selIdx, subIdx];
                        
                        <app-selectable-item-card
                          [name]="subOption.productOption.productName"
                          [quantity]="subOption.quantity"
                          [price]="subOption.productOption.priceIncrease"
                          [indentLevel]="2"
                          (remove)="onRemoveOption(item.index, subPath)">
                        </app-selectable-item-card>
                      }
                    }
                  }
                }
              }
              
              @if (items().length === 0) {
                <p class="empty-message">No hay items</p>
              }
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn-secondary" (click)="cancel()">
        Cancelar
      </button>
      <button 
        type="button"
        class="btn-primary" 
        [disabled]="!isAllValid()"
        (click)="confirm()">
        Confirmar {{ items().length }} Item(s)
      </button>
    </div>
  </div>
</div>

