<div class="modal-overlay" (click)="cancel()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    
    <!-- Header -->
    <div class="modal-header">
      @if (mode() === 'root') {
        <!-- ROOT MODE -->
        @if (currentContext().type === 'category') {
          <h2 class="modal-title">Seleccionar Producto</h2>
        } @else {
          <!-- In option mode, show back button and breadcrumb -->
          <div class="breadcrumb">
            <button 
              class="back-btn" 
              (click)="backToCategories()" 
              [disabled]="isEditMode()"
              [style.opacity]="isEditMode() ? '0.5' : '1'"
              [style.cursor]="isEditMode() ? 'not-allowed' : 'pointer'"
              title="Volver">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 16L6 10L12 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            @let context = currentContext();
            @if (context.itemIndex !== undefined) {
              @let item = items()[context.itemIndex];
              @if (item) {
                <span class="breadcrumb-current">{{ item.product.name }}</span>
                @if (context.optionPath && context.optionPath.length > 0) {
                  @let option = getOptionByPath(item.selections, context.optionPath);
                  @if (option) {
                    <span class="breadcrumb-separator">›</span>
                    <span class="breadcrumb-current">{{ option.productOption.productName }}</span>
                  }
                }
              }
            }
          </div>
        }
      } @else {
        <!-- PRODUCT MODE -->
        <h2 class="modal-title">
          {{ product()?.name }}
          @let path = currentContext().optionPath;
          @if (path && path.length > 0) {
            <span class="context-indicator"> › Configurando Sub-Opciones</span>
          }
        </h2>
      }
      <button class="close-btn" (click)="cancel()">✕</button>
    </div>

    <!-- Tabs -->
    @if (currentContext().type === 'category') {
      <div class="tabs">
        @for (category of categories(); track category.id; let i = $index) {
          <button 
            class="tab" 
            [class.active]="activeTabIndex() === i"
            (click)="switchTab(i)">
            {{ category.name }}
          </button>
        }
      </div>
    } @else {
      <div class="tabs">
        @for (group of currentProductGroups(); track group.id; let i = $index) {
          @let summary = groupSummaries()[i];
          <button 
            class="tab" 
            [class.active]="activeTabIndex() === i"
            [class.complete]="summary.isValid"
            (click)="switchTab(i)">
            {{ group.name }}
            <span class="tab-count">{{ summary.current }}/{{ summary.min }}</span>
          </button>
        }
      </div>
    }

    <!-- Content Area -->
    <div class="modal-body">
      @if (currentContext().type === 'category') {
        <!-- Category: Product Grid -->
        <div class="options-grid">
          @if (isLoadingCategories()) {
            <div class="loading-message">Cargando categorías...</div>
          } @else if (categoryProducts().length === 0) {
            <div class="empty-message">No hay productos en esta categoría</div>
          } @else {
            @for (product of categoryProducts(); track product.id) {
              <button 
                type="button"
                class="option-btn"
                (click)="selectProduct(product)">
                <span class="option-name">{{ product.name }}</span>
                @if (product.price && product.price > 0) {
                  <span class="option-price">${{ product.price.toFixed(2) }}</span>
                }
              </button>
            }
          }
        </div>
      } @else {
        <!-- Options: Product Options Grid -->
        @let group = activeGroup();
        @if (group && group.options && group.options.length > 0) {
          <div class="options-grid">
            @for (option of group.options; track option.id) {
              <button 
                type="button"
                class="option-btn"
                [class.selected]="getOptionCount(option) > 0"
                [disabled]="isOptionDisabled(option)"
                (click)="selectOption(option)">
                <span class="option-name">{{ option.productName }}</span>
                @if (option.priceIncrease && option.priceIncrease > 0) {
                  <span class="option-price">+\${{ option.priceIncrease.toFixed(2) }}</span>
                }
                @if (getOptionCount(option) > 0) {
                  <span class="option-badge">{{ getOptionCount(option) }}</span>
                }
              </button>
            }
          </div>
        } @else {
          <div class="loading-message">Cargando opciones...</div>
        }
      }
    </div>

    <!-- Selected Items Sidebar -->
    @if (items().length > 0) {
      <div class="selected-items-panel">
        <h3 class="panel-title">Items Seleccionados</h3>
        
        <div class="items-list">
          @for (item of items(); track $index; let itemIndex = $index) {
            @let itemKey = 'item-' + itemIndex;
            @let isExpanded = expandedItems().has(itemKey);
            @let isCurrentItem = currentContext().itemIndex === itemIndex && currentContext().type === 'option';
            
            <app-selectable-item-card
              [name]="item.product.name"
              [quantity]="1"
              [price]="calculateItemPrice(item)"
              [isSelected]="isCurrentItem"
              [hasChildren]="item.selections.length > 0"
              [isExpanded]="isExpanded"
              [indentLevel]="0"
              [isInvalid]="isItemInvalid(item)"
              [badges]="isExpanded ? [] : getItemBadges(item)"
              (clicked)="onItemClick(itemIndex)"
              (remove)="onRemoveItem(itemIndex)"
              (toggleExpand)="toggleItemExpansion(itemKey)">
            </app-selectable-item-card>

            @if (isExpanded && item.selections.length > 0) {
              <div class="options-tree">
                <app-selected-option-tree
                  [options]="item.selections"
                  [basePath]="[]"
                  [indentLevel]="1"
                  [expandedKeys]="expandedItems()"
                  [selectedItemIndex]="currentContext().itemIndex ?? -1"
                  [selectedOptionPath]="currentContext().optionPath || []"
                  [keyPrefix]="itemKey"
                  [validationFn]="areSelectionsValidFn"
                  (optionClicked)="onOptionClick(itemIndex, $event)"
                  (optionRemoved)="onRemoveOption(itemIndex, $event)"
                  (toggleExpand)="toggleItemExpansion($event)">
                </app-selected-option-tree>
              </div>
            }
          }
        </div>
      </div>
    }

    <!-- Footer -->
    <div class="modal-footer">
      @if (currentContext().type === 'category') {
        <div class="validation-status">
          @if (items().length === 0) {
            <span class="validation-message incomplete">Seleccione al menos un producto</span>
          } @else if (!isAllValid()) {
            <span class="validation-message incomplete">Complete las opciones requeridas</span>
          } @else {
            <span class="validation-message complete">✓ Todo completo</span>
          }
        </div>
      } @else {
        <div class="validation-status">
          @for (summary of groupSummaries(); track $index; let i = $index) {
            @if (i === activeTabIndex()) {
              @if (summary.isValid) {
                <span class="validation-message complete">
                  ✓ {{ summary.groupName }}: {{ summary.current }}/{{ summary.min }}
                </span>
              } @else {
                <span class="validation-message incomplete">
                  {{ summary.groupName }}: {{ summary.current }}/{{ summary.min }} (mínimo no alcanzado)
                </span>
              }
            }
          }
        </div>
      }
      
      <div class="button-group">
        <button class="btn-secondary" (click)="cancel()">Cancelar</button>
        <button 
          class="btn-primary" 
          [disabled]="!isAllValid() || items().length === 0"
          (click)="confirm()">
          Confirmar ({{ items().length }})
        </button>
      </div>
    </div>

  </div>
</div>
