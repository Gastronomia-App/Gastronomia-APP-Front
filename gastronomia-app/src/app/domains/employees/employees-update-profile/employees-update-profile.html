<section class="upd-modal-root" tabindex="0">
  <div class="upd-overlay" (click)="close()"></div>

  <div class="upd-dialog" (click)="$event.stopPropagation()">
    <!-- Header -->
    <header class="upd-dlg-header">
      <div class="upd-hdr">
        <h2>Editar Información Personal</h2>
        <p>Completa y actualiza todos tus datos personales</p>
      </div>
      <button
        class="upd-icon-btn"
        type="button"
        aria-label="Cerrar"
        (click)="close()"
      >
        <svg
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </header>

    <div class="upd-dlg-body">
      <!-- ==================== Información Personal ==================== -->
      <section class="upd-section">
        <form [formGroup]="form" class="upd-grid-2">
          <!-- Nombre -->
          <label class="upd-field">
            <span class="upd-label">Nombre</span>
            <div class="upd-input">
              <input
                type="text"
                formControlName="firstName"
                [placeholder]="currentUser.firstName"
                autocomplete="off"
              />
            </div>
          </label>

          <!-- Apellido -->
          <label class="upd-field">
            <span class="upd-label">Apellido</span>
            <div class="upd-input">
              <input
                type="text"
                formControlName="lastName"
                [placeholder]="currentUser.lastName"
                autocomplete="off"
              />
            </div>
          </label>

          <!-- Teléfono -->
          <label class="upd-field">
            <span class="upd-label">
              <svg viewBox="0 0 24 24">
                <path
                  d="M6.6 10.8a12 12 0 0 0 6.6 6.6l2.2-2.2 3.2 1.1a1.5 1.5 0 0 1 1 1.4V20a2 2 0 0 1-2.2 2A18 18 0 0 1 2 6.2 2 2 0 0 1 4 4h2.3a1.5 1.5 0 0 1 1.4 1l1.1 3.2z"
                />
              </svg>
              Teléfono
            </span>

            <div class="upd-input">
              <input
                type="tel"
                formControlName="phone"
                [placeholder]="currentUser.phone"
                autocomplete="off"
              />
            </div>
          </label>

          <!-- Email -->
          <label class="upd-field">
            <span class="upd-label">
              <svg
                class="email-icon"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
              >
                <rect x="3" y="5" width="18" height="14" rx="2" />
                <path d="M3 7l9 7 9-7" />
              </svg>
              Correo electrónico
            </span>

            <div class="upd-input">
              <input
                type="email"
                formControlName="email"
                [placeholder]="currentUser.email"
                autocomplete="off"
              />
            </div>
          </label>
        </form>
      </section>

      <div class="upd-divider"></div>

      <!-- ==================== Credenciales ==================== -->
      <section class="upd-section">
        <div class="upd-section-title">
          <div class="upd-pill">
            <svg viewBox="0 0 24 24">
              <path
                d="M12 1 3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4Z"
              />
            </svg>
          </div>
          <span>Credenciales de Cuenta</span>
        </div>

        <form [formGroup]="form" class="upd-grid-2">
          <!-- Username -->
          <label class="upd-field">
            <span class="upd-label">
              <svg
                class="username-icon"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
              >
                <path d="M16 8a4 4 0 1 0-.6 6.9" />
                <path
                  d="M16 8v6a2 2 0 1 0 4 0v-2a8 8 0 1 0-3.3 6.3"
                />
              </svg>
              Username
            </span>

            <div
              class="upd-input upd-input-suffix"
              [class.upd-error-border]="usernameTooLong() || usernameTooShort()"
            >
              <input
                type="text"
                formControlName="usernameLocal"
                [placeholder]="localDefault"
                autocomplete="off"
                autocapitalize="none"
                spellcheck="false"
              />

              <span class="upd-suffix">{{ domain }}</span>
            </div>

            <!-- Contador -->
            <div
              class="upd-username-counter"
              [class.upd-error-text]="usernameTooLong() || usernameTooShort()"
            >
              {{ usernameTotalLength() }} / {{ MAX_TOTAL_USERNAME }}
            </div>

            <!-- Mensajes de error -->
            @if (usernameTooLong()) {
              <small class="upd-error">
                Máximo {{ MAX_TOTAL_USERNAME }} caracteres para el nombre de
                usuario (sin contar el dominio).
              </small>
            }

            @if (usernameTooShort()) {
              <small class="upd-error">
                Mínimo {{ MIN_USERNAME }} caracteres para el nombre de usuario.
              </small>
            }
          </label>

          <!-- Password -->
          <label class="upd-field">
            <span class="upd-label">
              <svg
                class="password-icon"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
              >
                <rect x="4" y="11" width="16" height="9" rx="2" />
                <path d="M8 11V9a4 4 0 1 1 8 0v2" />
              </svg>
              Contraseña
            </span>

            <div
              class="upd-input upd-input-icon"
              [class.upd-error-border]="passwordTooShort() || passwordTooLong()"
            >
              <input
                [type]="showPassword() ? 'text' : 'password'"
                formControlName="password"
                placeholder="••••••••"
                autocomplete="new-password"
              />

              <button
                type="button"
                class="upd-icon-inline"
                (click)="togglePassword()"
                [attr.aria-pressed]="showPassword()"
              >
                <svg
                  class="eye-icon"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                >
                  <path
                    d="M2 12c2.6-4.6 6.2-7 10-7s7.4 2.4 10 7c-2.6 4.6-6.2 7-10 7s-7.4-2.4-10-7z"
                  />
                  <circle cx="12" cy="12" r="4" />
                </svg>
              </button>
            </div>

            <div
              class="upd-username-counter"
              [class.upd-error-text]="passwordTooShort() || passwordTooLong()"
            >
              {{ passwordLength() }} / {{ MAX_PASSWORD }}
            </div>

            @if (passwordTooShort()) {
              <small class="upd-error">
                La contraseña debe tener al menos {{ MIN_PASSWORD }} caracteres.
              </small>
            }

            @if (passwordTooLong()) {
              <small class="upd-error">
                La contraseña no puede superar los {{ MAX_PASSWORD }}
                caracteres.
              </small>
            }
          </label>
        </form>
      </section>

      <!-- ==================== Vista previa ==================== -->
      <section class="upd-preview">
        <div class="upd-preview-hdr">
          <div class="upd-pill">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path
                d="M12 3l3 6 7 .9-5 5 1.2 7.1L12 18l-6.2 3.9L7 15l-5-5 7-.9z"
              />
            </svg>
          </div>
          <span>Vista Previa</span>
        </div>

        <div class="upd-preview-body">
          <div class="upd-avatar">
            <svg viewBox="0 0 24 24">
              <circle cx="12" cy="8" r="4" />
              <path d="M4 20a8 8 0 0 1 16 0z" />
            </svg>
          </div>

          <div class="upd-pv-info">
            <div class="upd-pv-name">
              {{ previewName() }}
            </div>

            <div class="upd-pv-user">
              {{ previewUsername() }}
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- Footer -->
    <footer class="upd-dlg-footer">
      <button class="upd-btn upd-btn-ghost" type="button" (click)="close()">
        Cancelar
      </button>
      <button
        class="upd-btn upd-btn-primary"
        type="button"
        (click)="submit()"
        [disabled]="isSubmitDisabled()"
      >
        Guardar todos los cambios
      </button>
    </footer>
  </div>

  @if (securityRedirect()) {
    <div class="security-redirect-overlay">
      <div class="security-redirect-card">
        <img
          src="assets/images/gastronomia-logo-g-black.png"
          alt="Gastronomía Logo"
          class="security-logo"
        />

        <h3>Actualización de credenciales</h3>
        <p>Por seguridad tu sesión se reiniciará.</p>

        <div class="countdown-text">
          Redirigiendo en {{ redirectCountdown() }} segundos…
        </div>

        <!-- Progress bar -->
        <div class="progress-bar">
          <div class="progress-fill"></div>
        </div>
      </div>
    </div>
  }
</section>
