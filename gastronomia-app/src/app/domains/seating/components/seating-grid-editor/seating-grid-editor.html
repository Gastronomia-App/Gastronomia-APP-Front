<!-- =========================================================
     ðŸ§± ESTRUCTURA PRINCIPAL DEL EDITOR DE MESAS
     ========================================================= -->
<div class="editor-wrapper">
  <div class="grid-scroll" #gridScrollRef>

    <!-- ðŸŽ¯ CONTENEDOR VISUAL DEL GRID -->
    <div class="grid-container">
      <div class="grid" [style.--cols]="cols()" [style.--rows]="rows()">

        <!-- =====================================================
             ðŸ”² CELDAS DE LA GRILLA
             ===================================================== -->
        @for (r of [].constructor(rows()); track $index; let row = $index) {
          @for (c of [].constructor(cols()); track $index; let col = $index) {
            <div
              class="grid-cell"
              #cellRef
              [attr.data-row]="row"
              [attr.data-col]="col"
              [class.selected]="isCellSelected(row, col)"
              (mouseenter)="hoverCell(row, col)"
              (mouseleave)="hoverCell(null, null)"
              (dragover)="onDragOverCell(row, col, $event)"
              (dragleave)="onDragLeaveCell()"
              (drop)="onDrop(row, col)"
              (click)="onCellClick(row, col, $event, cellRef)">

              <!-- =================================================
                   ðŸª‘ MESA EXISTENTE
                   ================================================= -->
              @if (getSeatingAt(row, col)) {
                <div
                  class="seat {{ getSeatClasses(getSeatingAt(row, col)!) }}"
                  [attr.data-id]="getSeatingAt(row, col)!.id"
                  [class.selected]="isSelected(getSeatingAt(row, col)!)"
                  draggable="true"
                  (dragstart)="onDragStart(getSeatingAt(row, col)!, $event)"
                  (dragend)="onDragEnd()"
                  (click)="onSeatClick(getSeatingAt(row, col)!, $event, cellRef)">
                  <span class="seat-number">{{ getSeatingAt(row, col)!.number }}</span>
                </div>

              <!-- =================================================
                   ðŸ‘» MESA EN MODO DRAFT (PREVIEW TEMPORAL)
                   ================================================= -->
              } @else if (draftSeat() && draftSeat()!.posY === row + 1 && draftSeat()!.posX === col + 1) {
                <div class="seat preview draft {{ getSeatClasses(draftSeat()!) }}">
                  <span class="seat-number">{{ draftSeat()!.number }}</span>
                </div>

              <!-- =================================================
                   ðŸª„ PREVIEW DE DRAG (MESA ARRASTRADA)
                   ================================================= -->
              } @else if (draggedSeat && hoverTarget()?.row === row && hoverTarget()?.col === col) {
                <div class="seat preview {{ getSeatClasses(draggedSeat) }}">
                  <span class="seat-number">{{ draggedSeat.number }}</span>
                </div>

              <!-- =================================================
                   âž• CELDA VACÃA (POSIBLE CREACIÃ“N)
                   ================================================= -->
              } @else if (!draggedSeat) {
                <div class="empty" (click)="onCellClick(row, col, $event, cellRef)">
                  @if (isHovered(row, col)) { <span class="add-icon">+</span> }
                </div>
              } @else {
                <div class="empty"></div>
              }
            </div>
          }
        }
      </div>
    </div>

    <!-- =====================================================
         âš™ï¸ MENÃš CONTEXTUAL DE OPCIONES DE MESA
         ===================================================== -->
    @if (showMenu()) {
      <div
        class="context-menu"
        [style.top.px]="menuY()"
        [style.left.px]="menuX()"
        (click)="$event.stopPropagation()"
        (mousedown)="$event.stopPropagation()">

        <!-- Cambiar forma -->
        <button class="panel" (click)="toggleShape()" aria-label="Cambiar forma">
          <div class="icon">
            @if (menuShape() === 'ROUND') {
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="svg-icon">
                <circle cx="12" cy="12" r="7.5" fill="none" stroke="currentColor" stroke-width="2" />
              </svg>
            } @else {
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="svg-icon">
                <rect x="6.5" y="6.5" width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" rx="2" />
              </svg>
            }
          </div>
        </button>

        <!-- Cambiar tamaÃ±o -->
        <button class="panel" (click)="cycleSize()" aria-label="Cambiar tamaÃ±o">
          <div class="icon">
            @if (menuSize() === 'SMALL') {
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="svg-icon">
                <rect x="3.5" y="3.5" width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" rx="3" />
                <rect x="11" y="11" width="2" height="2" fill="currentColor" />
              </svg>
            } @else if (menuSize() === 'MEDIUM') {
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="svg-icon">
                <rect x="3.5" y="3.5" width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" rx="3" />
                <rect x="9" y="9" width="6" height="6" fill="currentColor" />
              </svg>
            } @else {
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="svg-icon">
                <rect x="3.5" y="3.5" width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" rx="3" />
                <rect x="7" y="7" width="10" height="10" fill="currentColor" />
              </svg>
            }
          </div>
        </button>

        <!-- Eliminar mesa -->
        @if (menuSeatId() !== null) {
          <button class="panel delete" (click)="onDeleteSeat()" aria-label="Eliminar mesa">
            <div class="icon">
              <svg xmlns="http://www.w3.org/2000/svg" class="svg-icon delete-icon" viewBox="0 0 16 16">
                <path
                  d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z" />
                <path
                  d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z" />
              </svg>
            </div>
          </button>
        }
      </div>
    }

  </div>
</div>