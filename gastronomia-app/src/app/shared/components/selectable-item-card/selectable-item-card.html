<div 
  class="item-card" 
  [class.selected]="isSelected()"
  [class.invalid]="isInvalid()"
  [class.editing-comment]="isEditingComment()"
  [style.padding-left]="'calc(var(--spacing-sm) + ' + (indentLevel() * 16) + 'px)'"
  (click)="onCardClick()">
  
  @if (hasChildren()) {
    <button 
      type="button"
      class="expand-btn"
      (click)="onToggleExpand($event)">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        @if (isExpanded()) {
          <polyline points="6 9 12 15 18 9"></polyline>
        } @else {
          <polyline points="9 18 15 12 9 6"></polyline>
        }
      </svg>
    </button>
  }
  
  @if (isEditingComment()) {
    <!-- Comment editing mode - input takes full width -->
    <input 
      type="text" 
      class="comment-edit-input"
      [(ngModel)]="editingCommentValue"
      (keydown)="onCommentKeyDown($event)"
      (blur)="saveComment()"
      (click)="$event.stopPropagation()"
      placeholder="Agregar comentario..." />
  } @else {
    <!-- Normal display mode -->
    <div class="item-info">
      <span class="item-name">{{ name() }}</span>
      @if (!isExpanded() && badges().length > 0) {
        <div class="badges-summary">
          @for (badge of badges(); track badge) {
            <span class="badge">{{ badge }}</span>
          }
        </div>
      }
    </div>
    
    @if (quantity()) {
      <span class="item-quantity">x{{ quantity() }}</span>
    }
    
    @if (price() && price()! > 0) {
      <span class="item-price">+${{ price()!.toFixed(2) }}</span>
    }
    
    @if (showCommentButton()) {
      <button 
        type="button"
        class="comment-btn"
        (click)="onCommentClick($event)"
        [title]="comment() ? 'Editar comentario' : 'Agregar comentario'">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
      </button>
    }
    
    <button 
      type="button"
      class="delete-btn"
      (click)="onDelete($event)">
      âœ•
    </button>
  }
  
  <!-- Comment display below all content -->
  @if (!isEditingComment() && comment() && comment()!.trim() !== '') {
    <div class="item-comment-wrapper">
      <span class="item-comment">{{ comment() }}</span>
    </div>
  }
</div>
